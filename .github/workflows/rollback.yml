name: Rollback Minecraft Server

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Docker image tag to rollback to (e.g., 0.0.10)'
        required: true
        type: string

jobs:
  rollback:
    environment: prod
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.SERVICE_ACCOUNT_KEY }}"
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"

      - name: Validate Image Exists
        run: |
          IMAGE_TAG="${{ github.event.inputs.version }}"
          IMAGE_PATH="europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:$IMAGE_TAG"

          if gcloud artifacts docker images list $IMAGE_PATH --include-tags --format="value(tags)"; then
            echo "Image $IMAGE_PATH exists. Proceeding with rollback."
          else
            echo "Error: Specified image tag does not exist!" >&2
            exit 1
          fi

      - name: Rollback to Selected Version
        run: |
          IMAGE_TAG="${{ github.event.inputs.version }}"
          gcloud compute instances update-container mc-server \
            --zone=${{ secrets.GCP_ZONE }} \
            --container-image=europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:$IMAGE_TAG

      - name: Confirm Rollback
        run: |
          echo "Minecraft server successfully rolled back to version: ${{ github.event.inputs.version }}"
