name: Rollback Minecraft Server (Auto & Manual)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Docker image tag to rollback to (leave empty for auto)'
        required: false
        type: string

  workflow_run:
    workflows: ["Build and Deploy Minecraft Server"]
    types:
      - completed

jobs:
  determine-rollback-version:
    environment: prod
    runs-on: ubuntu-latest
    outputs:
      rollback_version: ${{ steps.get_version.outputs.rollback_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.SERVICE_ACCOUNT_KEY }}"
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"

      - name: Determine Rollback Version
        id: get_version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "Using user-specified version: ${{ github.event.inputs.version }}"
            echo "rollback_version=${{ github.event.inputs.version }}" >> $GITHUB_ENV
            exit 0
          fi

          echo "Fetching latest successful image..."
          LATEST_TAG=$(gcloud artifacts docker images list europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure \
            --format="value(tags)" --sort-by="~update_time" | grep -Eo '0.0.[0-9]+' | head -n 2 | tail -n 1)

          if [[ -z "$LATEST_TAG" ]]; then
            echo "No previous version found. Aborting rollback!"
            exit 1
          fi

          echo "Rolling back to version: $LATEST_TAG"
          echo "rollback_version=$LATEST_TAG" >> $GITHUB_ENV

  rollback:
    needs: determine-rollback-version
    environment: prod
    runs-on: ubuntu-latest
    steps:
      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.SERVICE_ACCOUNT_KEY }}"
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Rollback to Selected Version
        run: |
          gcloud compute instances update-container mc-server \
            --zone=${{ secrets.GCP_ZONE }} \
            --container-image=europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:$rollback_version

      - name: Verify Rollback Success
        run: |
          sleep 10
          STATUS=$(gcloud compute instances describe mc-server --zone=${{ secrets.GCP_ZONE }} --format="value(status)")
          
          if [[ "$STATUS" == "RUNNING" ]]; then
            echo "Rollback successful! Server is running with version: $rollback_version"
          else
            echo "Rollback failed! Please check logs." >&2
            exit 1
          fi
