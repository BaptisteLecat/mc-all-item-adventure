name: Rollback Minecraft Server

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Docker image tag to rollback to (e.g., 0.0.10)'
        required: true
        type: string

jobs:
  rollback:
    environment: prod
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.SERVICE_ACCOUNT_KEY }}"
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"

      - name: Validate Image Exists
        run: |
          IMAGE_TAG="${{ github.event.inputs.version }}"
          echo "🔍 Checking if image tag $IMAGE_TAG exists in Artifact Registry..."

          # Récupère tous les tags d'images
          AVAILABLE_TAGS=$(gcloud artifacts docker images list europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure \
            --include-tags --format="value(tags)")

          # Vérifie si l'image demandée est dans la liste
          if echo "$AVAILABLE_TAGS" | grep -wq "$IMAGE_TAG"; then
            echo "✅ Image $IMAGE_TAG exists. Proceeding with rollback."
          else
            echo "❌ Error: Specified image tag '$IMAGE_TAG' does not exist!" >&2
            exit 1
          fi

      - name: Rollback to Selected Version
        run: |
          IMAGE_TAG="${{ github.event.inputs.version }}"
          gcloud compute instances update-container mc-server \
            --zone=${{ secrets.GCP_ZONE }} \
            --container-image=europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:$IMAGE_TAG

      - name: Confirm Rollback
        run: |
          IMAGE_TAG="${{ github.event.inputs.version }}"
          echo "Fetching deployed container image..."
          DEPLOYED_IMAGE=$(gcloud compute instances describe mc-server --zone=${{ secrets.GCP_ZONE }} \
            --format="json" | jq -r '.metadata.items[] | select(.key=="gce-container-declaration") | .value' | grep "image:" | awk '{print $2}')
          
          EXPECTED_IMAGE="europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:$IMAGE_TAG"

          if [ "$DEPLOYED_IMAGE" == "$EXPECTED_IMAGE" ]; then
            echo "✅ Rollback successful! Server is now running version $IMAGE_TAG."
          else
            echo "❌ Error: Rollback failed! Expected image $EXPECTED_IMAGE but got $DEPLOYED_IMAGE" >&2
            exit 1
          fi