name: build-plugins

on:
  push:
    branches:
      - main

jobs:
  build-gradle-jar:
    environment: prod
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21.0.6'

      - name: Set up Gradle
        uses: gradle/gradle-build-action@v2

      - name: Echo Java version and Gradle version
        run: |
          java -version
          gradle -version

      - name: Build all plugins
        run: |
          cd plugins
          for d in */ ; do
            cd "$d"
            gradle shadowJar
            cd ..
          done

      - name: Archive plugins
        uses: actions/upload-artifact@v4
        with:
          name: plugins
          path: plugins/*/build/libs/*.jar

  build-docker-image:
    environment: prod
    needs:
      - build-gradle-jar
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Create temporary directory
        run: |
          mkdir p plugin_jars

      - name: Download a single artifact
        uses: actions/download-artifact@v4
        with:
          name: plugins
          path: plugin_jars

      - name: Move JAR files to the root of plugin_jars
        run: |
          mkdir -p plugin_jars_flat
          find plugin_jars -name "*.jar" -exec mv {} plugin_jars_flat/ \;

      - id: "auth"
        uses: "google-github-actions/auth@v2"
        with:
          credentials_json: "${{ secrets.SERVICE_ACCOUNT_KEY }}"
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: "Set up Cloud SDK"
        uses: "google-github-actions/setup-gcloud@v1"

      - name: Configure Docker
        run: gcloud auth configure-docker europe-west1-docker.pkg.dev --quiet

      - name: Determine Image Tag
        run: echo "IMAGE_TAG=0.0.${{ github.run_number }}" >> $GITHUB_ENV

      - name: Build Docker image with dynamic tag
        run: |
          docker build --build-arg PLUGINS_DIR=plugin_jars_flat \
            -t europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:$IMAGE_TAG \
            -t europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:latest \
            -f docker/Dockerfile .

      - name: Push Docker images
        run: |
          docker push europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:$IMAGE_TAG
          docker push europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:latest

      - name: Update VM Container with New Image
        run: |
          gcloud compute instances update-container mc-server \
            --zone=${{ secrets.GCP_ZONE }} \
            --container-image=europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:$IMAGE_TAG

      - name: Fetch deployed container image
        run: |
          echo "Fetching deployed container image..."
          DEPLOYED_IMAGE=$(gcloud compute instances describe mc-server --zone=${{ secrets.GCP_ZONE }} \
            --format="json" | jq -r '.metadata.items[] | select(.key=="gce-container-declaration") | .value' | grep "image:" | awk '{print $2}')
          echo "Deployed Image: $DEPLOYED_IMAGE"

      - name: Health Check - Minecraft Server
        run: |
          SERVER_IP=$(gcloud compute instances describe mc-server --zone=${{ secrets.GCP_ZONE }} --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
          echo "Checking Minecraft server at $SERVER_IP:25565..."

          for i in {1..10}; do
            if nc -zv $SERVER_IP 25565; then
              echo "‚úÖ Minecraft server is UP!"
              exit 0
            fi
            echo "‚ùå Server not responding yet, retrying in 10s..."
            sleep 10
          done

          echo "‚ùå Minecraft server did not start in time."
          exit 1

      - name: Generate Deployment Report
        run: |
          echo "<h2>üöÄ Deployment Report</h2>" > deployment_report.html
          echo "<h3>üì¶ Docker Image</h3>" >> deployment_report.html
          echo "<p><strong>Deployed Image:</strong> europe-west1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/mc-all-item-adventure/mc-all-item-adventure:${IMAGE_TAG}</p>" >> deployment_report.html
          
          echo "<h3>üí° Build Information</h3>" >> deployment_report.html
          echo "<ul>" >> deployment_report.html
          echo "  <li><strong>GitHub Run ID:</strong> <a href='https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'>#${{ github.run_number }}</a></li>" >> deployment_report.html
          echo "  <li><strong>Commit:</strong> <a href='https://github.com/${{ github.repository }}/commit/${{ github.sha }}'>${{ github.sha }}</a></li>" >> deployment_report.html
          echo "  <li><strong>Branch:</strong> ${{ github.ref_name }}</li>" >> deployment_report.html
          echo "</ul>" >> deployment_report.html
          
          echo "<h3>üõ†Ô∏è Deployment Status</h3>" >> deployment_report.html
          SERVER_IP=$(gcloud compute instances describe mc-server --zone=${{ secrets.GCP_ZONE }} --format="get(networkInterfaces[0].accessConfigs[0].natIP)")
          if nc -zv $SERVER_IP 25565; then
            echo "<p style='color: green;'><strong>‚úÖ Minecraft server is UP!</strong></p>" >> deployment_report.html
          else
            echo "<p style='color: red;'><strong>‚ùå Minecraft server did NOT start!</strong></p>" >> deployment_report.html
          fi

          echo "<h3>üìú Logs & Details</h3>" >> deployment_report.html
          echo "<details><summary><strong>Show Deployment Logs</strong></summary>" >> deployment_report.html
          echo "<pre>" >> deployment_report.html
          gcloud compute instances describe mc-server --zone=${{ secrets.GCP_ZONE }} --format="json" | jq -r '.metadata.items[] | select(.key=="gce-container-declaration") | .value' >> deployment_report.html
          echo "</pre></details>" >> deployment_report.html

          echo "<p><em>Generated by GitHub Actions on $(date)</em></p>" >> deployment_report.html

      - name: Upload Deployment Report
        uses: actions/upload-artifact@v4
        with:
          name: deployment-report
          path: deployment_report.html


          
